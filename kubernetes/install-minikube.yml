---

- name: 禁用swap
  become: yes
  mount:
    path: swap
    state: absent
    backup: yes

- name: 开放端口：Kubelet API
  become: yes
  firewalld:
    zone=public
    port=10250/tcp
    permanent=true
    state=enabled

- name: 开放端口：dashboard
  become: yes
  firewalld:
    zone=public
    port=8443/tcp
    permanent=true
    state=enabled

- name: 复制镜像包
  copy:
    src: {{minikube-images}}
    dest: "/tmp/minikube-images/"

- name: 获取所有tar镜像文件路径
  find:
    paths: "/tmp/minikube-images/"
    patterns: "*.tar"
  register: rs

- name: 导入镜像
  become: yes
  shell: "docker load < {{item.path}}"
  with_items:
    - "{{rs.files}}"

- name: 复制kubectl和minikube
  become: yes
  copy:
    src: {{minikube-bin}}
    dest: "/usr/local/bin/"

- name: 配置执行权限
  file:
    path: "/usr/local/bin/"
    mode: a+x

- name: 启动集群
  become: yes
  shell: "http_proxy={{http-proxy}} sudo -E /usr/local/bin/minikube start --vm-driver=none"
  environment:
    CHANGE_MINIKUBE_NONE_USER: 'true'
    MINIKUBE_HOME: '$HOME'
    KUBECONFIG: '$HOME/.kube/config'
